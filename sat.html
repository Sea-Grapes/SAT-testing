<!DOCTYPE html>
<title>SAT Testing</title>
<script src="https://cdn.tailwindcss.com"></script>

<main class='flex flex-col lg:flex-row gap-8 max-w-8xl mx-auto p-8'>
  <section class='shrink-0'>
    <header class='align-top p-6 border border-slate-300 rounded-lg'>
      <div class='mb-10 space-y-1'>
        <h1 class='text-2xl font-semibold'>SAT Testing Lookup</h1>
        <p class='text-slate-500 text-sm'>Search for SAT testing locations near you</p>
      </div>
      <form class='space-y-5'>
        <div>
          <label for='zipcode' class='block mb-2 text-slate-600 font-medium'>Zip code</label>
          <input id='zipcode' placeholder='Enter zip code' pattern='^\d{5}(-\d{4})?$' required
            class='min-w-full h-9 px-3 py-1 text-sm border border-slate-300 rounded-lg outline-none focus:border-slate-500'
            type='text'>
        </div>
        <div>
          <label for='distance' class='block mb-2 text-slate-600 font-medium'>Max distance (miles)</label>
          <input id='distance' placeholder='Enter distance' value='25' min='0' max='10000' type='number'
            class='min-w-full h-9 px-3 py-1 text-sm border border-slate-300 rounded-lg outline-none focus:border-slate-500'>
        </div>
        <button type='button' class='min-w-full p-2 text-center bg-slate-100 hover:bg-slate-200 rounded-lg border border-slate-300'>Search</button>
      </form>
    </header>
  </section>
  <section class='grow'>
    <div class='border border-slate-300 rounded-lg overflow-hidden'>
      <table class='min-w-full'>
        <thead class='divide-y divide-slate-300 *:divide-x *:divide-slate-300'>
          <tr class='bg-slate-100 font-medium text-slate-400 text-left *:py-4 *:px-6'>
            <th>Date</th>
            <th>School</th>
            <th>Address</th>
            <th>Distance</th>
          </tr>
        </thead>
        <tbody class='divide-y divide-slate-300 *:divide-x *:divide-slate-300'></tbody>
      </table>
    </div>
  </section>
</main>

<script>
const log = msg => console.log(`[SAT] ${msg}`)


function fetchData() {
  log('Updating data...')
  data = {
    'August 24, 2024 — Saturday': [
      ['Rainier Beach High School', '8815 Seward Park Avenue South Seattle, WA 98118', 11.65],
      ['Rainier Beach High School', '8815 Seward Park Avenue South Seattle, WA 98118', 11.65],
      ['Rainier Beach High School', '8815 Seward Park Avenue South Seattle, WA 98118', 11.65],
    ],
    'October 5, 2024 — Saturday': [
      ['Rainier Beach High School', '8815 Seward Park Avenue South Seattle, WA 98118', 11.65],
      ['Rainier Beach High School', '8815 Seward Park Avenue South Seattle, WA 98118', 11.65],
      ['Rainier Beach High School', '8815 Seward Park Avenue South Seattle, WA 98118', 11.65],
    ]
  }

  localStorage.setItem('data', JSON.stringify(data))
  localStorage.setItem('time', Date.now())
  setUI()
}

function make(parent, node, call) {
  node = document.createElement(node)
  parent.append(node)
  if (call) call(node)
  return node
}

const table = document.querySelector('tbody')
function setUI() {
  table.innerHTML = ''

  for (const [date, options] of Object.entries(data)) {
    options.forEach(([school, address, distance]) => {

      const row = make(table, 'tr', tr => tr.classList = '*:py-4 *:px-6')
      make(row, 'td', td => td.textContent = date)
      make(row, 'td', td => td.textContent = school)
      make(row, 'td', td => {
        make(td, 'a', a => {
          a.classList = 'underline text-blue-600 hover:text-blue-800 visited:text-purple-600'
          a.href = `https://www.google.com/maps/search/?api=1&query=${address}`
          a.textContent = address
        })
      })
      make(row, 'td', td => td.textContent = `${distance} mi`)
    })
  }
}

const zip = document.querySelector('#zipcode')
const distance = document.querySelector('#distance')
document.querySelector('button').addEventListener('click', e => {
  console.log(zip.value, distance.value)
})

const currentTime = Date.now()
log(`Systems online ${currentTime}ms`)

const previousTime = localStorage.getItem('time') ?? 0
log(`Last updated ${previousTime}ms`)

const delayMS = currentTime - previousTime
const delayH = delayMS / (1000 * 60 * 60)
log(`It has been ${delayH.toFixed(3)}h since last fetched`)

let data = JSON.parse(localStorage.getItem('data'))
if (delayH > 12) fetchData()
else setUI()
// fetch(`https://sat-admin-dates.collegeboard.org/`).then(res => res.json()).then(days => {
//   days = days.map(e => e.eventFormattedDate)
//   window.days = days
//   console.log(days)

//   days.forEach(day => fetch(`https://aru-test-center-search.collegeboard.org/prod/test-centers?date=${day}&zip=98075&country=US`))
// })
// .catch(e => alert('Error with CollegeBoard API'))
</script>